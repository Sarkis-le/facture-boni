<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Factures – Cabinet Maître Boni</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" type="image/jpg" href="logo_cabinet.jpg">

  <!-- Bootstrap (pour une base propre) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- jsPDF + autotable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --bg-page: #020617;
      --bg-main: #ffffff;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --accent-dark: #1d4ed8;
      --danger-soft: #fee2e2;
      --danger: #b91c1c;
      --border-subtle: #e5e7eb;
      --text-main: #0f172a;
      --text-muted: #6b7280;
      --radius-xl: 0.9rem;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background:
        radial-gradient(circle at top left, #0f172a, #020617 55%),
        radial-gradient(circle at bottom right, #020617, #020617 60%);
      color: var(--text-main);
      min-height: 100vh;
    }

    header {
      padding: 1.7rem 1rem 1rem;
      text-align: center;
      color: #e5e7eb;
    }

    header h1 {
      font-size: 1.7rem;
      margin: 0 0 .3rem;
      letter-spacing: .04em;
      text-transform: uppercase;
    }

    header .subtitle {
      color: #9ca3af;
      font-size: .9rem;
    }

    main {
      max-width: 1100px;
      margin: 0 auto 2.5rem;
      background: radial-gradient(circle at top left, #f9fafb, #ffffff);
      padding: 1.75rem 1.5rem 2rem;
      border-radius: var(--radius-xl);
      box-shadow:
        0 30px 60px rgba(15, 23, 42, .40),
        0 0 0 1px rgba(148, 163, 184, 0.18);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    h2 {
      font-size: 1.05rem;
      margin-top: 0;
      margin-bottom: .6rem;
      color: #0f172a;
      display: flex;
      align-items: center;
      gap: .4rem;
    }

    h2::before {
      content: "";
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
    }

    /* Boutons – on surclasse Bootstrap pour garder ton style */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      padding: .55rem 1.4rem;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: .9rem;
      gap: .35rem;
      transition: transform .1s ease, box-shadow .1s ease, background-color .15s ease, color .15s ease;
      white-space: nowrap;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(15, 23, 42, .18);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: white;
      padding-inline: 1.7rem;
      box-shadow: 0 14px 28px rgba(37, 99, 235, .45);
      border: none;
    }

    .btn-primary:hover {
      background: var(--accent-dark);
    }

    .btn-soft {
      background: #f3f4f6;
      color: #111827;
      border: 1px solid #e5e7eb;
      box-shadow: none;
    }

    .btn-danger {
      background: var(--danger-soft);
      color: var(--danger);
      border: 1px solid #fecaca;
      font-size: .8rem;
      padding: .25rem .6rem;
      box-shadow: none;
      margin-top: 0;
    }

    .btn-sm {
      padding: .35rem .9rem;
      font-size: .8rem;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.25rem;
      gap: 1rem;
    }

    .top-bar-title {
      display: flex;
      flex-direction: column;
    }

    .top-bar-title span:first-child {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .top-bar-title span:last-child {
      font-size: .8rem;
      color: var(--text-muted);
    }

    /* Cartes de stats */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(190px,1fr));
      gap: .85rem;
      margin-bottom: 1.4rem;
    }

    .stat-card {
      position: relative;
      border-radius: .9rem;
      padding: .8rem .9rem;
      background: radial-gradient(circle at top left, var(--accent-soft), #ffffff);
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 10px 22px rgba(15,23,42,.10);
      overflow: hidden;
    }

    .stat-card::after {
      content: "";
      position: absolute;
      inset: auto -25% -60%;
      height: 120%;
      background: radial-gradient(circle at bottom, rgba(37,99,235,.15), transparent 60%);
      opacity: .9;
      pointer-events: none;
    }

    .stat-label {
      font-size: .75rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--text-muted);
      margin-bottom: .25rem;
      position: relative;
      z-index: 1;
    }

    .stat-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-main);
      position: relative;
      z-index: 1;
    }

    .stat-sub {
      font-size: .75rem;
      color: var(--text-muted);
      margin-top: .15rem;
      position: relative;
      z-index: 1;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: .5rem;
      overflow: hidden;
      border-radius: .7rem;
      background: white;
    }

    th, td {
      border: 1px solid #000;
      padding: .45rem .55rem;
      font-size: .83rem;
      text-align: left;
      color: #000;
    }

    th {
      font-weight: 600;
      background: #f3f4f6;
    }

    .dashboard-table tbody tr:hover {
      background: #f9fafb;
    }

    .dashboard-table td:last-child {
      text-align: right;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: .1rem .5rem;
      border-radius: 999px;
      font-size: .7rem;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      color: #4b5563;
    }

    /* MODAL – version opaque, sans conflit avec Bootstrap */
    .boni-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.70);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      padding: 1rem;
    }

    .boni-backdrop.show {
      display: flex;
    }

    .boni-modal {
      width: 100%;
      max-width: 900px;
      max-height: 90vh;
      background-color: #ffffff;
      color: #0f172a;
      border-radius: 1rem;
      box-shadow:
        0 30px 60px rgba(15, 23, 42, .55),
        0 0 0 1px rgba(148, 163, 184, 0.25);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .modal-header {
      padding: 1rem 1.5rem .6rem;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: .5rem;
      background: linear-gradient(to right, #eff6ff, #ffffff);
    }

    .modal-header h3 {
      margin: 0;
      font-size: 1.05rem;
    }

    .modal-body {
      padding: 1rem 1.5rem 1.2rem;
      overflow-y: auto;
      background-color: #ffffff;
    }

    .modal-footer {
      padding: .8rem 1.5rem 1.1rem;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: .7rem;
      background: #f9fafb;
    }

    .step-indicator {
      display: flex;
      gap: .5rem;
      font-size: .8rem;
      color: var(--text-muted);
      margin-bottom: .7rem;
      flex-wrap: wrap;
    }

    .step-indicator span {
      display: inline-flex;
      align-items: center;
      gap: .25rem;
      padding: .15rem .5rem;
      border-radius: 999px;
      background: #f3f4f6;
    }

    .step-indicator .current {
      font-weight: 600;
      color: var(--accent-dark);
      background: var(--accent-soft);
    }

    .step-indicator .dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #d1d5db;
    }

    .step-indicator .current .dot {
      background: var(--accent);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(260px,1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    label {
      font-size: .8rem;
      font-weight: 600;
      color: #374151;
      display: block;
      margin-bottom: .25rem;
    }

    input {
      width: 100%;
      padding: .55rem .75rem;
      border-radius: .7rem;
      border: 1px solid #d1d5db;
      font-size: .9rem;
      background: #f9fafb;
      transition: border-color .15s ease, box-shadow .15s ease, background-color .15s ease;
    }

    input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37,99,235,.3);
      background: #ffffff;
    }

    .editor-container {
      border-radius: .8rem;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      overflow: hidden;
    }

    .editor-toolbar {
      display: flex;
      gap: .25rem;
      padding: .3rem .4rem;
      border-bottom: 1px solid #e5e7eb;
      background: #f3f4f6;
    }

    .editor-toolbar button {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: .85rem;
      padding: .15rem .4rem;
      border-radius: .4rem;
      color: #4b5563;
    }

    .editor-toolbar button:hover {
      background: #e5e7eb;
    }

    .editor {
      min-height: 140px;
      max-height: 260px;
      padding: .55rem .7rem .7rem;
      overflow-y: auto;
      font-size: .9rem;
      background: #ffffff;
      /* >>> pour se rapprocher d’un Word : on respecte tous les espaces, retours, tabulations */
      white-space: pre-wrap;
      tab-size: 4;
    }

    .editor:focus {
      outline: none;
    }

    .totaux {
      text-align: right;
      margin-top: .75rem;
      font-size: .9rem;
      color: #111827;
    }

    .totaux span {
      display: block;
    }

    #totalGlobal {
      font-size: 1rem;
      font-weight: 700;
    }

    .footer-note {
      font-size: .75rem;
      color: var(--text-muted);
      margin-top: 1.2rem;
      border-top: 1px dashed #e5e7eb;
      padding-top: .7rem;
    }

    code {
      background: #0b1120;
      color: #e5e7eb;
      padding: 2px 6px;
      border-radius: .35rem;
      font-size: .75rem;
    }

    @media (max-width: 640px) {
      main {
        margin-inline: 0.75rem;
        padding-inline: 1.1rem;
      }
      header h1 {
        font-size: 1.3rem;
      }
      .modal {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
<header>
  <h1>Factures – Cabinet d'Avocat Maître Boni</h1>
  <div class="subtitle">Tableau de bord &amp; génération de factures d'honoraires</div>
</header>

<main>
  <div class="top-bar">
    <div class="top-bar-title">
      <span>Tableau de bord des factures</span>
      <span>Historique local (navigateur) des factures générées</span>
    </div>
    <button type="button" class="btn btn-primary" onclick="ouvrirModal()">
      + Nouvelle facture
    </button>
  </div>

  <!-- Cartes de statistiques -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-label">Factures enregistrées</div>
      <div class="stat-value" id="statCount">0</div>
      <div class="stat-sub">Total des factures dans ce navigateur</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Montant cumulé</div>
      <div class="stat-value" id="statSum">0,00 €</div>
      <div class="stat-sub">Somme de tous les honoraires</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Dernière facture</div>
      <div class="stat-value" id="statLast">–</div>
      <div class="stat-sub">Date de la dernière facture générée</div>
    </div>
  </div>

  <section aria-label="Liste des factures">
    <h2>Historique des factures</h2>
    <div class="table-responsive">
      <table class="dashboard-table">
        <thead>
        <tr>
          <th>Numéro</th>
          <th>Date</th>
          <th>Affaire</th>
          <th>Destinataire</th>
          <th>Montant</th>
          <th>Actions</th>
        </tr>
        </thead>
        <tbody id="tbodyFactures">
        <!-- Lignes remplies en JS -->
        </tbody>
      </table>
    </div>
  </section>

  <p class="footer-note">
    Les factures sont stockées dans le <em>localStorage</em> du navigateur.  
    Placez l’image <code>entete-boni.jpg</code> dans le même dossier que ce fichier, puis déployez sur GitHub / Vercel.
  </p>
</main>

<!-- MODAL CREATION FACTURE -->
<div class="boni-backdrop" id="backdrop">
  <div class="boni-modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">

    <div class="modal-header">
      <h3 id="modalTitle">Nouvelle facture d'honoraires</h3>
      <button type="button" class="btn btn-soft btn-sm" onclick="fermerModal()">Fermer</button>
    </div>
    <div class="modal-body">
      <div class="step-indicator">
        <span class="current" id="stepLabel1"><span class="dot"></span> Étape 1 : Infos</span>
        <span id="stepLabel2"><span class="dot"></span> Étape 2 : Honoraires</span>
        <span id="stepLabel3"><span class="dot"></span> Étape 3 : Texte</span>
        <span id="stepLabel4"><span class="dot"></span> Étape 4 : Vérification</span>
      </div>

      <!-- Étape 1 -->
      <div class="step" id="step1">
        <h2>Informations générales</h2>
        <div class="grid">
          <div>
            <label for="affaire">Affaire</label>
            <input id="affaire" type="text" placeholder="DIOME Modou / LEBLOND Jennifer">
          </div>
          <div>
            <label for="nosRef">Nos références</label>
            <input id="nosRef" type="text" placeholder="Cor : 8257, MD : 133974 - FD">
          </div>
          <div>
            <label for="vosRef">Vos références</label>
            <input id="vosRef" type="text" placeholder="">
          </div>
        </div>

        <h2>Destinataire</h2>
        <div class="grid">
          <div>
            <label for="destNomLigne1">Ligne 1 (ex : Monsieur le Directeur …)</label>
            <input id="destNomLigne1" type="text" placeholder="Monsieur le Directeur de …">
          </div>
          <div>
            <label for="destNomLigne2">Ligne 2</label>
            <input id="destNomLigne2" type="text" placeholder="Adresse complète">
          </div>
          <div>
            <label for="destNomLigne3">Ligne 3</label>
            <input id="destNomLigne3" type="text" placeholder="Code postal – Ville">
          </div>
        </div>
      </div>

      <!-- Étape 2 -->
      <div class="step" id="step2" style="display:none">
        <h2>Lignes d’honoraires</h2>
        <button type="button" class="btn btn-soft btn-sm" onclick="ajouterLigne()">
          + Ajouter une ligne
        </button>
        <table id="tableLignes" style="margin-top:.7rem;">
          <thead>
          <tr>
            <th>Libellé</th>
            <th>Date</th>
            <th>Montant (€)</th>
            <th></th>
          </tr>
          </thead>
          <tbody>
          <!-- lignes JS -->
          </tbody>
        </table>
        <div class="totaux">
          <span>Total :</span>
          <span id="totalGlobal">0,00 €</span>
        </div>
      </div>

      <!-- Étape 3 -->
      <div class="step" id="step3" style="display:none">
        <h2>Texte de la lettre</h2>
        <p style="font-size:.8rem;color:var(--text-muted);margin-top:-.2rem;margin-bottom:.4rem;">
          Vous pouvez mettre du gras, italique, listes… comme dans un petit Word.  
          La touche <strong>Tab</strong> fonctionne aussi pour les tabulations.
        </p>
        <div class="editor-container">
          <div class="editor-toolbar">
            <button type="button" onclick="execCmd('bold')"><b>B</b></button>
            <button type="button" onclick="execCmd('italic')"><i>I</i></button>
            <button type="button" onclick="execCmd('underline')"><u>U</u></button>
            <button type="button" onclick="execCmd('insertUnorderedList')">• Liste</button>
            <button type="button" onclick="execCmd('insertOrderedList')">1. Liste</button>
          </div>
          <div id="editorTexte" class="editor" contenteditable="true">
Mon Cher Confrère,

J’ai le plaisir de vous adresser en retour l’expédition de …
          </div>
        </div>
      </div>

      <!-- Étape 4 -->
      <div class="step" id="step4" style="display:none">
        <h2>Vérification &amp; récapitulatif</h2>
        <div id="recap" style="font-size:.88rem;line-height:1.5;">
          <!-- Récapitulatif injecté en JS -->
        </div>
      </div>

    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-soft btn-sm" id="btnPrev" onclick="changerEtape(-1)" disabled>Étape précédente</button>
      <div style="display:flex;gap:.5rem;align-items:center;">
        <span class="badge" id="badgeAuto"></span>
        <button type="button" class="btn btn-primary btn-sm" id="btnNext" onclick="changerEtape(1)">Étape suivante</button>
      </div>
    </div>
  </div>
</div>

<script>
  const STORAGE_KEY = 'factures_boni';
  const SIRET = 'xxxxxxxxxxxxx'; // À adapter une fois pour toutes
  let factures = [];
  let currentStep = 1;
  let totalGlobal = 0;

  /* ---------- UTIL LOCALSTORAGE ---------- */

  function chargerFactures() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      factures = raw ? JSON.parse(raw) : [];
    } catch (e) {
      factures = [];
    }
  }

  function sauvegarderFactures() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(factures));
  }

  function formatEuro(n) {
    return n.toFixed(2).replace('.', ',') + ' €';
  }

  function majStats() {
    const countEl = document.getElementById('statCount');
    const sumEl = document.getElementById('statSum');
    const lastEl = document.getElementById('statLast');
    if (!countEl || !sumEl || !lastEl) return;

    const count = factures.length;
    countEl.textContent = count;

    let sum = 0;
    factures.forEach(f => { sum += f.totalMontant || 0; });
    sumEl.textContent = formatEuro(sum);

    if (count > 0) {
      const last = factures.reduce((a, b) => (a.id > b.id ? a : b));
      const dateTexte = (last.dateTexte || '').replace('Bordeaux, le ', '');
      lastEl.textContent = dateTexte || '—';
    } else {
      lastEl.textContent = '–';
    }
  }

  function rafraichirTableau() {
    const tbody = document.getElementById('tbodyFactures');
    tbody.innerHTML = '';
    if (!factures.length) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 6;
      td.textContent = "Aucune facture enregistrée pour le moment.";
      td.style.textAlign = 'center';
      td.style.fontSize = '.85rem';
      td.style.color = '#6b7280';
      tr.appendChild(td);
      tbody.appendChild(tr);
      majStats();
      return;
    }

    factures.slice().reverse().forEach(f => {
      const tr = document.createElement('tr');

      const tdNum = document.createElement('td');
      tdNum.textContent = f.numero;

      const tdDate = document.createElement('td');
      tdDate.textContent = f.dateTexte;

      const tdAff = document.createElement('td');
      tdAff.textContent = f.affaire || '';

      const tdDest = document.createElement('td');
      tdDest.textContent = (f.dest1 || '') + (f.dest3 ? ' – ' + f.dest3 : '');

      const tdMontant = document.createElement('td');
      tdMontant.textContent = formatEuro(f.totalMontant || 0);

      const tdAct = document.createElement('td');
      tdAct.style.textAlign = 'right';
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn btn-soft btn-sm';
      btn.textContent = 'PDF';
      btn.onclick = () => genererPDF(f);
      tdAct.appendChild(btn);

      tr.appendChild(tdNum);
      tr.appendChild(tdDate);
      tr.appendChild(tdAff);
      tr.appendChild(tdDest);
      tr.appendChild(tdMontant);
      tr.appendChild(tdAct);

      tbody.appendChild(tr);
    });

    majStats();
  }

  /* ---------- MODAL & ÉTAPES ---------- */

  function ouvrirModal() {
    document.getElementById('backdrop').classList.add('show');
    currentStep = 1;
    majEtapes();
    resetForm();
  }

  function fermerModal() {
    document.getElementById('backdrop').classList.remove('show');
  }

  function changerEtape(delta) {
    const newStep = currentStep + delta;
    if (newStep < 1 || newStep > 4) return;
    currentStep = newStep;
    if (currentStep === 4) {
      construireRecapitulatif();
    }
    majEtapes();
  }

  function majEtapes() {
    for (let i = 1; i <= 4; i++) {
      document.getElementById('step' + i).style.display = (i === currentStep) ? 'block' : 'none';
      const lbl = document.getElementById('stepLabel' + i);
      if (i === currentStep) lbl.classList.add('current'); else lbl.classList.remove('current');
    }
    document.getElementById('btnPrev').disabled = (currentStep === 1);
    const btnNext = document.getElementById('btnNext');
    if (currentStep < 4) {
      btnNext.textContent = 'Étape suivante';
      btnNext.onclick = () => changerEtape(1);
    } else {
      btnNext.textContent = 'Enregistrer et générer le PDF';
      btnNext.onclick = () => enregistrerEtGenerer();
    }

    const now = new Date();
    const jj = String(now.getDate()).padStart(2, '0');
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const aaaa = now.getFullYear();
    const hh = String(now.getHours()).padStart(2, '0');
    const min = String(now.getMinutes()).padStart(2, '0');

    const dateTexte = `Bordeaux, le ${jj}/${mm}/${aaaa}`;
    const numero = `FAC-${aaaa}${mm}${jj}-${hh}${min}`;
    const badge = document.getElementById('badgeAuto');
    badge.textContent = `Date : ${dateTexte} – N° : ${numero}`;
  }

  function resetForm() {
    document.getElementById('affaire').value = '';
    document.getElementById('nosRef').value = '';
    document.getElementById('vosRef').value = '';
    document.getElementById('destNomLigne1').value = '';
    document.getElementById('destNomLigne2').value = '';
    document.getElementById('destNomLigne3').value = '';
    document.getElementById('editorTexte').innerHTML =
`Mon Cher Confrère,

J’ai le plaisir de vous adresser en retour l’expédition de …`;

    const tbody = document.querySelector('#tableLignes tbody');
    tbody.innerHTML = '';
    ajouterLigne({
      libelle: "Honoraires – Assignation en référé TJ",
      date: "",
      montant: "91.12"
    });
    recalculer();
  }

  /* ---------- LIGNES HONORAIRES ---------- */

  function ajouterLigne(data = {}) {
    const tbody = document.querySelector('#tableLignes tbody');
    const tr = document.createElement('tr');

    tr.innerHTML = `
      <td><input type="text" class="libelle" value="${data.libelle || ''}"></td>
      <td><input type="text" class="datePresta" value="${data.date || ''}"></td>
      <td><input type="number" step="0.01" class="montant" value="${data.montant || ''}" oninput="recalculer()"></td>
      <td><button type="button" class="btn btn-danger" onclick="supprimerLigne(this)">×</button></td>
    `;
    tbody.appendChild(tr);
    recalculer();
  }

  function supprimerLigne(btn) {
    btn.closest('tr').remove();
    recalculer();
  }

  function recalculer() {
    let total = 0;
    document.querySelectorAll('#tableLignes tbody tr').forEach(tr => {
      const input = tr.querySelector('.montant');
      if (!input) return;
      const val = (input.value || '').toString().replace(',', '.');
      const montant = parseFloat(val || '0');
      if (!isNaN(montant)) total += montant;
    });
    totalGlobal = total;
    document.getElementById('totalGlobal').textContent = formatEuro(totalGlobal);
  }

  /* ---------- ÉDITEUR DE TEXTE ---------- */

  function execCmd(cmd) {
    document.execCommand(cmd, false, null);
  }

  function getTexteBrutDepuisHTML(html) {
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    return tmp.innerText || tmp.textContent || '';
  }

  // >>> Gestion de la touche Tab dans l’éditeur pour faire de vraies « tabulations »
  function initEditorTabSupport() {
    const editor = document.getElementById('editorTexte');
    if (!editor) return;
    editor.addEventListener('keydown', function (e) {
      if (e.key === 'Tab') {
        e.preventDefault();
        // on insère 4 espaces (tabulation “Word-like”)
        document.execCommand('insertText', false, '    ');
      }
    });
  }

  /* ---------- RECAP & ENREGISTREMENT ---------- */

  function construireRecapitulatif() {
    const affaire = document.getElementById('affaire').value;
    const nosRef = document.getElementById('nosRef').value;
    const vosRef = document.getElementById('vosRef').value;
    const dest1 = document.getElementById('destNomLigne1').value;
    const dest2 = document.getElementById('destNomLigne2').value;
    const dest3 = document.getElementById('destNomLigne3').value;
    const texteHTML = document.getElementById('editorTexte').innerHTML;

    const recap = document.getElementById('recap');
    recap.innerHTML = `
      <p><strong>Affaire :</strong> ${affaire || '-'}</p>
      <p><strong>Nos réf :</strong> ${nosRef || '-'}<br>
      <strong>Vos réf :</strong> ${vosRef || '-'}</p>
      <p><strong>Destinataire :</strong><br>
      ${(dest1 || '')}<br>${(dest2 || '')}<br>${(dest3 || '')}</p>
      <p><strong>Nombre de lignes d’honoraires :</strong> ${document.querySelectorAll('#tableLignes tbody tr').length}</p>
      <p><strong>Total :</strong> ${formatEuro(totalGlobal)}</p>
      <p><strong>Texte de la lettre :</strong><br>
      <div style="border:1px solid #e5e7eb;border-radius:.5rem;padding:.4rem .5rem;background:#f9fafb;max-height:160px;overflow:auto;font-size:.86rem;">
      ${texteHTML}
      </div></p>
    `;
  }

  function enregistrerEtGenerer() {
    const now = new Date();
    const jj = String(now.getDate()).padStart(2, '0');
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const aaaa = now.getFullYear();
    const hh = String(now.getHours()).padStart(2, '0');
    const min = String(now.getMinutes()).padStart(2, '0');

    const dateTexte = `Bordeaux, le ${jj}/${mm}/${aaaa}`;
    const numero = `FAC-${aaaa}${mm}${jj}-${hh}${min}`;

    const affaire = document.getElementById('affaire').value;
    const nosRef = document.getElementById('nosRef').value;
    const vosRef = document.getElementById('vosRef').value;
    const dest1 = document.getElementById('destNomLigne1').value;
    const dest2 = document.getElementById('destNomLigne2').value;
    const dest3 = document.getElementById('destNomLigne3').value;
    const texteHTML = document.getElementById('editorTexte').innerHTML;
    const texteBrut = getTexteBrutDepuisHTML(texteHTML); // on garde EXACTEMENT le texte tapé (lignes, tabulations => espaces)

    const lignes = [];
    document.querySelectorAll('#tableLignes tbody tr').forEach(tr => {
      const libelle = tr.querySelector('.libelle')?.value || '';
      const dateP = tr.querySelector('.datePresta')?.value || '';
      const val = (tr.querySelector('.montant')?.value || '').toString().replace(',', '.');
      const montant = parseFloat(val || '0');
      lignes.push({
        libelle,
        date: dateP,
        montant: isNaN(montant) ? 0 : montant
      });
    });

    const facture = {
      id: Date.now(),
      numero,
      dateTexte,
      affaire,
      nosRef,
      vosRef,
      dest1,
      dest2,
      dest3,
      texteHTML,
      texteBrut,
      lignes,
      totalMontant: totalGlobal,
      siret: SIRET
    };

    factures.push(facture);
    sauvegarderFactures();
    rafraichirTableau();
    genererPDF(facture);
    fermerModal();
  }

  /* ---------- NOMBRE EN LETTRES (FR) ---------- */

  function nombreEnLettres(n) {
    n = Math.round(n * 100) / 100;
    const euros = Math.floor(n);
    const cents = Math.round((n - euros) * 100);

    function enLettresEntier(x) {
      const unites = ['zéro','un','deux','trois','quatre','cinq','six','sept','huit','neuf',
        'dix','onze','douze','treize','quatorze','quinze','seize'];
      const dizaines = ['','dix','vingt','trente','quarante','cinquante','soixante'];
      if (x < 17) return unites[x];
      if (x < 20) return 'dix-' + unites[x - 10];
      if (x < 70) {
        const d = Math.floor(x / 10);
        const u = x % 10;
        if (u === 0) return dizaines[d];
        if (u === 1 && (d >= 2 && d <= 6)) return dizaines[d] + '-et-un';
        return dizaines[d] + '-' + unites[u];
      }
      if (x < 80) {
        const u = x - 60;
        if (u === 1) return 'soixante-et-onze';
        return 'soixante-' + enLettresEntier(u);
      }
      if (x < 100) {
        const u = x - 80;
        let base = 'quatre-vingt';
        if (u === 0) return base + 's';
        if (u === 1) return base + '-un';
        return base + '-' + enLettresEntier(u);
      }
      if (x < 200) {
        if (x === 100) return 'cent';
        return 'cent ' + enLettresEntier(x - 100);
      }
      if (x < 1000) {
        const c = Math.floor(x / 100);
        const r = x % 100;
        let cent = (c === 1) ? 'cent' : unites[c] + ' cents';
        if (r === 0) return cent;
        if (c > 1) cent = unites[c] + ' cent';
        return cent + ' ' + enLettresEntier(r);
      }
      if (x < 1000000) {
        const m = Math.floor(x / 1000);
        const r = x % 1000;
        let mille = (m === 1) ? 'mille' : enLettresEntier(m) + ' mille';
        if (r === 0) return mille;
        return mille + ' ' + enLettresEntier(r);
      }
      if (x < 1000000000) {
        const M = Math.floor(x / 1000000);
        const r = x % 1000000;
        let million = (M === 1) ? 'un million' : enLettresEntier(M) + ' millions';
        if (r === 0) return million;
        return million + ' ' + enLettresEntier(r);
      }
      return x.toString();
    }

    let texte = '';
    if (euros === 0) texte = 'zéro euro';
    else if (euros === 1) texte = 'un euro';
    else texte = enLettresEntier(euros) + ' euros';

    if (cents > 0) {
      if (cents === 1) texte += ' et un centime';
      else texte += ' et ' + enLettresEntier(cents) + ' centimes';
    }

    return texte;
  }

  /* ---------- NORMALISATION TEXTE POUR LE PDF ---------- */

  function normaliserTextePourPdf(texte) {
    // On convertit les tabulations en 4 espaces pour être sûr qu’elles s’affichent bien
    return texte.replace(/\t/g, '    ');
  }

  /* ---------- GENERATION PDF ---------- */

  function genererPDF(facture) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'pt', format: 'A4' });
    const margeG = 50;

    const entete = new Image();
    entete.src = 'entete-boni.jpg';

    entete.onload = function () {
      doc.addImage(entete, 'JPEG', 0, 0, 595, 165);

      let y = 210;

      doc.setFont('Helvetica', 'bold');
      doc.setFontSize(13);
      doc.text("FACTURE D'HONORAIRES", 595 / 2, y, { align: 'center' });
      y += 18;
      doc.setFontSize(12);
      doc.text(`N° ${facture.numero}`, 595 / 2, y, { align: 'center' });
      y += 30;

      doc.setFont('Helvetica', 'normal');
      doc.setFontSize(11);

      // Bloc destinataire à droite
      let destY = y;
      const xRight = 360;
      if (facture.dest1 || facture.dest2 || facture.dest3) {
        doc.setFont('Helvetica', 'bold');
        if (facture.dest1) {
          doc.text(facture.dest1, xRight, destY);
          destY += 14;
        }
        doc.setFont('Helvetica', 'normal');
        if (facture.dest2) {
          doc.text(facture.dest2, xRight, destY);
          destY += 12;
        }
        if (facture.dest3) {
          doc.text(facture.dest3, xRight, destY);
          destY += 12;
        }
      }

      destY += 16;
      doc.text(facture.dateTexte, xRight, destY);

      let yInfos = destY + 24;
      doc.text("Nos réf : " + (facture.nosRef || ''), margeG, yInfos); yInfos += 14;
      doc.text("Affaire : " + (facture.affaire || ''), margeG, yInfos); yInfos += 14;
      doc.text("Vos réf : " + (facture.vosRef || ''), margeG, yInfos); yInfos += 14;
      doc.text("N° SIRET : " + (facture.siret || ''), margeG, yInfos); yInfos += 24;

      let yCourant = yInfos;

      // >>> Texte de la lettre : on respecte LIGNE PAR LIGNE ce que tu as tapé (avec tabulations)
      const texteIntro = normaliserTextePourPdf(facture.texteBrut || "");
      if (texteIntro.trim().length > 0) {
        const paragraphs = texteIntro.split(/\r?\n/);
        paragraphs.forEach(p => {
          const trimmed = p.replace(/\s+$/,''); // on évite des espaces inutiles en fin
          const lines = doc.splitTextToSize(trimmed, 500);
          if (lines.length) {
            doc.text(lines, margeG, yCourant);
            yCourant += lines.length * 14;
          } else {
            // ligne vide => saut de ligne
            yCourant += 14;
          }
        });
        yCourant += 16;
      }

      // Tableau des honoraires
      const body = [];
      (facture.lignes || []).forEach(l => {
        const libelle = l.libelle || '';
        const dateP = l.date || '';
        const montant = l.montant || 0;
        body.push([
          libelle + (dateP ? " (" + dateP + ")" : ""),
          montant.toFixed(2).replace('.', ',')
        ]);
      });

      if (body.length > 0) {
        doc.autoTable({
          startY: yCourant,
          head: [['Libellé', 'Montant (€)']],
          body: body,
          theme: 'grid',
          styles: {
            fontSize: 9,
            lineColor: [0,0,0],
            textColor: [0,0,0],
            lineWidth: 0.3
          },
          headStyles: {
            fillColor: [243, 244, 246],
            textColor: [0,0,0],
            lineColor: [0,0,0],
            lineWidth: 0.5,
            fontStyle: 'bold'
          },
          columnStyles: {
            1: { halign: 'right' }
          },
          margin: { left: margeG, right: 45 }
        });
        yCourant = doc.lastAutoTable.finalY + 14;

        doc.setFont('Helvetica', 'bold');
        doc.setDrawColor(0,0,0);
        doc.line(335, yCourant - 10, 545, yCourant - 10);
        doc.text(
          `Total : ${facture.totalMontant.toFixed(2).replace('.', ',')} €`,
          545,
          yCourant,
          { align: 'right' }
        );
        yCourant += 22;
      }

      // Décompte en lettres
      if (facture.totalMontant > 0) {
        doc.setFont('Helvetica', 'normal');
        const montantLettre = nombreEnLettres(facture.totalMontant).toUpperCase();
        const phraseDec =
          `Le décompte laisse apparaître un solde de ${montantLettre} ` +
          `(${facture.totalMontant.toFixed(2).replace('.', ',')} €), dont règlement à vos bons soins.`;
        const decLines = doc.splitTextToSize(phraseDec, 500);
        doc.text(decLines, margeG, yCourant);
        yCourant += decLines.length * 14 + 28;
      }

      // Signature
      doc.setFont('Helvetica', 'bold');
      doc.text("Maître Bio Bienvenu BONI", 545, yCourant, { align: 'right' });
      yCourant += 14;
      doc.setFont('Helvetica', 'normal');
      doc.text("Avocat au barreau de Bordeaux", 545, yCourant, { align: 'right' });

      doc.save(`facture-${facture.numero}.pdf`);
    };
  }

  /* ---------- INIT ---------- */

  document.addEventListener('DOMContentLoaded', () => {
    chargerFactures();
    rafraichirTableau();
    initEditorTabSupport(); // >>> activation de la touche Tab dans l’éditeur
  });
</script>
</body>
</html>

